<!--
 * Project: FORTH WorkTime Analyzer
 * File: index.html
 * Full Implementation v1.0.0 (2025-08-11)
 * Note: รวม UI, Styling, และ Logic การทำงานฝั่ง Client ทั้งหมดไว้ในไฟล์เดียว
-->
<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WorkTime Analyzer (v1.0.0)</title>

  <!-- Google Fonts: Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- External Libraries: Firebase, PDF Parsing, Charting -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Outfit', 'sans-serif'],
          },
          colors: {
            primary: { DEFAULT: '#7C3AED', 50: '#F5F3FF', 100: '#EDE9FE', 500: '#8B5CF6', 600: '#7C3AED', 700: '#6D28D9' }, // Violet
            secondary: { DEFAULT: '#D946EF', 50: '#FDF4FF', 500: '#D946EF', 600: '#C026D3' }, // Fuchsia
          },
          boxShadow: {
            soft: '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
            glass: '0 8px 32px 0 rgba(31, 38, 135, 0.07)'
          }
        }
      }
    }
  </script>
  <!-- Firebase SDKs (Compat version for easier vanilla usage) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Embedded CSS Styles -->
  <style>
    /* --- General Styles --- */
    * {
      -webkit-tap-highlight-color: transparent;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader {
      width: 20px;
      height: 20px;
      border: 3px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input.ot-input:focus,
    input.pay-input:focus {
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
      border-color: #6366f1;
    }

    /* --- Professional Print Styles for A4 --- */
    @media print {
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        background-color: #ffffff !important;
        font-size: 10pt;
      }

      .no-print {
        display: none !important;
      }

      .print-section {
        box-shadow: none !important;
        border: 1px solid #e2e8f0;
        margin-top: 1rem;
        padding: 0.75rem;
      }

      .print-header {
        display: block !important;
      }

      /* ทำให้หัวตารางแสดงซ้ำในทุกหน้าที่พิมพ์ */
      thead {
        display: table-header-group;
      }

      tr {
        page-break-inside: avoid;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }
    }

    /* --- Glassmorphism Utils --- */
    .glass {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
  </style>
</head>

<body
  class="min-h-screen bg-slate-50 text-slate-800 antialiased bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-indigo-100 via-slate-50 to-white">
  <!-- Print-only header: ส่วนหัวที่จะแสดงเฉพาะตอนสั่งพิมพ์รายงาน -->
  <header class="hidden print:block print-header p-4 border-b border-slate-200">
    <div class="flex justify-between items-center">
      <h1 class="text-lg font-bold">WorkTime Analyzer - Monthly Report</h1>
      <p id="print-date" class="text-sm text-slate-600"></p>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-2 sm:p-4 md:p-6 space-y-6">
    <header class="flex justify-between items-center no-print">
      <div class="text-left">
        <h1 class="text-3xl font-bold text-slate-800" data-i18n="appTitle">WorkTime Analyzer</h1>
        <p class="text-slate-500 mt-1" data-i18n="appSubtitle">โปรแกรมสรุปเวลาทำงานและ OT (Monthly Report)</p>
      </div>
      <div class="flex items-center space-x-2">
        <button id="lang-th-button"
          class="px-3 py-1 text-sm font-semibold rounded-md transition-colors bg-indigo-600 text-white">TH</button>
        <button id="lang-en-button"
          class="px-3 py-1 text-sm font-semibold rounded-md transition-colors bg-slate-200 text-slate-700">EN</button>
      </div>
    </header>

    <!-- Upload Section -->
    <section
      class="glass-card rounded-2xl p-4 sm:p-6 no-print transition-all duration-300 hover:shadow-indigo-200/50 hover:shadow-2xl">
      <label for="file-input"
        class="relative cursor-pointer flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-primary/30 rounded-xl hover:bg-primary/5 transition-all group">
        <div id="uploader-content" class="text-center">
          <svg class="mx-auto h-10 w-10 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"
            aria-hidden="true">
            <path
              d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4V12a4 4 0 014-4h12l4-4h12a4 4 0 014 4v4m-8 4l-4-4m0 0l-4 4m4-4v12"
              stroke-width="2" />
          </svg>
          <span class="mt-2 block text-sm font-semibold text-primary group-hover:scale-105 transition-transform"
            data-i18n="uploaderText">คลิกเพื่อเลือกไฟล์
            PDF</span>
          <p id="uploader-filename" class="text-xs text-slate-500 truncate max-w-xs" data-i18n="uploaderFilename"
            data-i18n-default="ยังไม่ได้เลือกไฟล์">ยังไม่ได้เลือกไฟล์</p>
        </div>
        <div id="uploader-loader" class="hidden text-center">
          <div class="loader mx-auto text-indigo-500"></div>
          <p class="mt-2 text-sm text-slate-600" data-i18n="loaderText">กำลังประมวลผล...</p>
        </div>
        <input id="file-input" type="file" accept="application/pdf" class="sr-only" />
      </label>
      <div id="error-message-box"
        class="hidden mt-4 rounded-xl border border-rose-200 bg-rose-50 p-3 text-rose-700 text-sm"></div>
    </section>

    <!-- Results Section: ซ่อนไว้จนกว่าจะมีการประมวลผลสำเร็จ -->
    <section id="results-section" class="hidden space-y-6">
      <div class="glass-card rounded-2xl p-4 sm:p-6 print-section">
        <div id="report-summary-header" class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <div class="text-sm text-slate-500" data-i18n="reportMonthHeader">รายงานสรุปเดือน</div>
            <div id="report-month-year" class="text-xl font-semibold">–</div>
          </div>
          <div class="text-left sm:text-right">
            <div class="text-sm text-slate-500" data-i18n="totalNetHoursHeader">ชั่วโมงทำงานสุทธิรวม</div>
            <div id="report-total-hours" class="text-3xl font-bold text-indigo-600">0.00 ชม.</div>
          </div>
          <button id="print-button"
            class="px-5 py-2.5 mt-4 sm:mt-0 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-semibold flex items-center gap-2 self-start sm:self-center no-print shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:scale-105 transition-all text-sm"
            data-i18n="printButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd"
                d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.06.752.18 1.128.368a.75.75 0 11-.53 1.341c-.554-.22-1.158-.339-1.848-.339H5.25V4.5a.75.75 0 00-1.5 0v11.75A1.75 1.75 0 005.5 18h9a1.75 1.75 0 001.75-1.75V11a.75.75 0 00-1.5 0v4.25a.25.25 0 01-.25.25h-9a.25.25 0 01-.25-.25V4.5a.25.25 0 01.25-.25h.5V2.75z"
                clip-rule="evenodd" />
              <path
                d="M10.25 6h1.5a2.25 2.25 0 012.25 2.25v1.5a.75.75 0 01-1.5 0v-1.5a.75.75 0 00-.75-.75h-1.5a.75.75 0 00-.75.75v9a.75.75 0 00.75.75h1.5a.75.75 0 00.75-.75V12a.75.75 0 011.5 0v3.75a2.25 2.25 0 01-2.25 2.25h-1.5a2.25 2.25 0 01-2.25-2.25v-9A2.25 2.25 0 0110.25 6z" />
            </svg>
            พิมพ์รายงาน
          </button>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-4 sm:p-6 print-section">
        <h3 class="font-semibold mb-3" data-i18n="otSummaryTitle">สรุป OT (หน่วย: ชั่วโมง)</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="text-xs text-slate-500">OT 1.0</div>
            <div id="summary-ot-10" class="text-2xl font-bold tabular-nums">0.00</div>
          </div>
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="text-xs text-slate-500">OT 1.5</div>
            <div id="summary-ot-15" class="text-2xl font-bold tabular-nums">0.00</div>
          </div>
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="text-xs text-slate-500">OT 2.0</div>
            <div id="summary-ot-20" class="text-2xl font-bold tabular-nums">0.00</div>
          </div>
          <div class="rounded-xl border border-slate-200 p-3">
            <div class="text-xs text-slate-500">OT 3.0</div>
            <div id="summary-ot-30" class="text-2xl font-bold tabular-nums">0.00</div>
          </div>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-4 sm:p-6 print-section">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
          <div>
            <h3 class="font-semibold mb-3" data-i18n="payCalcTitle">คำนวณค่าแรง OT</h3>
            <div class="space-y-4">
              <label class="block text-sm">
                <span data-i18n="monthlySalaryLabel">เงินเดือน (บาท/เดือน)</span>
                <input id="monthly-salary-input" type="number" min="0" placeholder="30000"
                  class="pay-input mt-1 w-full rounded-md border border-slate-300 p-2 text-right outline-none transition-shadow text-base">
              </label>
              <label class="block text-sm">
                <span data-i18n="baseHoursLabel">ชั่วโมงฐานต่อเดือน (เช่น 26×8)</span>
                <input id="base-hours-input" type="number" min="1" value="208"
                  class="pay-input mt-1 w-full rounded-md border border-slate-300 p-2 text-right outline-none transition-shadow text-base">
              </label>
              <div class="text-sm text-slate-600 pt-2">
                <span data-i18n="effectiveRateLabel">ค่าแรงต่อชั่วโมงที่ใช้คำนวณ</span>
                <div class="text-xl font-semibold text-indigo-700">฿ <span id="effective-rate-display">0.00</span></div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="font-semibold mb-3" data-i18n="otPayoutTitle">สรุปค่าแรง OT (บาท)</h3>
            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="text-xs text-slate-500">OT 1.0</div>
                <div id="payout-ot-10" class="text-lg font-bold">฿ 0.00</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="text-xs text-slate-500">OT 1.5</div>
                <div id="payout-ot-15" class="text-lg font-bold">฿ 0.00</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="text-xs text-slate-500">OT 2.0</div>
                <div id="payout-ot-20" class="text-lg font-bold">฿ 0.00</div>
              </div>
              <div class="rounded-xl border border-slate-200 bg-slate-50 p-3">
                <div class="text-xs text-slate-500">OT 3.0</div>
                <div id="payout-ot-30" class="text-lg font-bold">฿ 0.00</div>
              </div>
            </div>
            <div class="mt-4 text-right">
              <div class="text-sm text-slate-600" data-i18n="totalOtPayLabel">รวมค่าแรง OT ทั้งหมด:</div>
              <div id="total-ot-payout" class="text-2xl font-bold text-emerald-600">฿ 0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-2 sm:p-6 print-section">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 print:bg-slate-100">
              <tr>
                <th class="px-3 py-2 text-left font-semibold text-slate-600 whitespace-nowrap" data-i18n="tableDate">
                  วันที่</th>
                <th class="px-3 py-2 text-left font-semibold text-slate-600 whitespace-nowrap" data-i18n="tableInOut">
                  เวลาเข้า–ออก</th>
                <th class="px-3 py-2 text-right font-semibold text-slate-600" data-i18n="tableNetHours">ชม. (สุทธิ)</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-600">OT 1.0</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-600">OT 1.5</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-600">OT 2.0</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-600">OT 3.0</th>
                <th class="px-3 py-2 text-center font-semibold text-slate-600" data-i18n="tableStatus">สถานะ</th>
              </tr>
            </thead>
            <tbody id="results-table-body" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
      </div>

      <div class="glass-card rounded-2xl p-4 sm:p-6 no-print">
        <h2 class="text-base font-semibold mb-3" data-i18n="chartTitle">กราฟชั่วโมงทำงานสุทธิต่อวัน</h2>
        <div class="h-[280px]"><canvas id="report-chart"></canvas></div>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-slate-400 p-6 no-print">
    <p data-i18n="footerText">© 2025 WorkTime Analyzer (Vanilla JS) Pro Edition</p>
    <p class="mt-1 opacity-60">Powered by Firebase</p>
  </footer>

  <script type="text/javascript" defer>
      (function main() {
        /**
         * Logic การทำงานทั้งหมดของแอปพลิเคชัน อยู่ภายใน IIFE (Immediately Invoked Function Expression)
         * เพื่อป้องกันการรั่วไหลของตัวแปรไปยัง Global Scope
         */
        const initializeApp = () => {
          // --- Firebase Setup ---
          const firebaseConfig = {
            apiKey: "AIzaSyDj_9ps_wx9SAHfNy1xMXpM_ukliwm6q30",
            authDomain: "forth-worktime-app.firebaseapp.com",
            projectId: "forth-worktime-app",
            storageBucket: "forth-worktime-app.firebasestorage.app",
            messagingSenderId: "248890234668",
            appId: "1:248890234668:web:addb07c0abe6e6e371fe89",
            measurementId: "G-K2H2JMHTJK"
          };

          try {
            firebase.initializeApp(firebaseConfig);
            if (firebase.analytics) {
              firebase.analytics();
            }
            console.log("Firebase initialized successfully");

            // Auth Listener Example
            firebase.auth().onAuthStateChanged((user) => {
              if (user) {
                console.log("User is signed in:", user.uid);
              } else {
                console.log("No user is signed in.");
              }
            });
          } catch (error) {
            console.warn("Firebase Config missing or invalid. Please update the config object.", error);
          }

          // ตั้งค่า Worker สำหรับ PDF.js เพื่อให้ทำงานใน background thread
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js`;

          // Internationalization (i18n) Dictionary: เก็บข้อความทั้งหมดสำหรับ 2 ภาษา
          const i18nDict = {
            en: { appTitle: "WorkTime Analyzer", appSubtitle: "Monthly OT & Work Summary Report", uploaderText: "Click to select a PDF file", uploaderFilename: "No file selected", loaderText: "Processing...", reportMonthHeader: "Summary for", totalNetHoursHeader: "Total Net Work Hours", otSummaryTitle: "OT Summary (Hours)", payCalcTitle: "OT Pay Calculation", monthlySalaryLabel: "Monthly Salary (THB/Month)", baseHoursLabel: "Base Hours per Month (e.g., 26×8)", effectiveRateLabel: "Effective Hourly Rate", otPayoutTitle: "OT Payout Summary (THB)", totalOtPayLabel: "Total OT Pay:", tableDate: "Date", tableInOut: "In-Out Time", tableNetHours: "Net (Hrs)", tableStatus: "Status", chartTitle: "Daily Net Work Hours Chart", footerText: "© 2025 WorkTime Analyzer (Vanilla JS) Pro Edition", errorPrefix: "Error: ", errorNoDate: "Could not find a valid date format (dd.mm.yyyy) in the document.", statusWeekend: "Weekend", statusHoliday: "Holiday", printButton: "Print Report" },
            th: { appTitle: "WorkTime Analyzer", appSubtitle: "โปรแกรมสรุปเวลาทำงานและ OT (Monthly Report)", uploaderText: "คลิกเพื่อเลือกไฟล์ PDF", uploaderFilename: "ยังไม่ได้เลือกไฟล์", loaderText: "กำลังประมวลผล...", reportMonthHeader: "รายงานสรุปเดือน", totalNetHoursHeader: "ชั่วโมงทำงานสุทธิรวม", otSummaryTitle: "สรุป OT (หน่วย: ชั่วโมง)", payCalcTitle: "คำนวณค่าแรง OT", monthlySalaryLabel: "เงินเดือน (บาท/เดือน)", baseHoursLabel: "ชั่วโมงฐานต่อเดือน (เช่น 26×8)", effectiveRateLabel: "ค่าแรงต่อชั่วโมงที่ใช้คำนวณ", otPayoutTitle: "สรุปค่าแรง OT (บาท)", totalOtPayLabel: "รวมค่าแรง OT ทั้งหมด:", tableDate: "วันที่", tableInOut: "เวลาเข้า–ออก", tableNetHours: "ชม. (สุทธิ)", tableStatus: "สถานะ", chartTitle: "กราฟชั่วโมงทำงานสุทธิต่อวัน", footerText: "© 2025 WorkTime Analyzer (Vanilla JS) Pro Edition", errorPrefix: "เกิดข้อผิดพลาด: ", errorNoDate: "ไม่พบรูปแบบวันที่ (dd.mm.yyyy) ที่ถูกต้องในเอกสาร", statusWeekend: "วันหยุดสุดสัปดาห์", statusHoliday: "วันหยุดนักขัตฤกษ์", printButton: "พิมพ์รายงาน" }
          };

          // App State: เก็บสถานะทั้งหมดของแอปพลิเคชันไว้ในที่เดียว
          let appState = {
            lang: 'th',
            busy: false,
            data: [],
            otInputs: {},
            monthIdx: null,
            year: null,
            chartInstance: null,
            pay: { monthlySalary: 0, baseHours: 208 }
          };

          // DOM References: แคชการเข้าถึง Element เพื่อประสิทธิภาพที่ดีกว่า
          const DOM = {
            html: document.documentElement,
            fileInput: document.getElementById('file-input'),
            uploaderContent: document.getElementById('uploader-content'),
            uploaderLoader: document.getElementById('uploader-loader'),
            uploaderFilename: document.getElementById('uploader-filename'),
            errorMessage: document.getElementById('error-message-box'),
            resultsSection: document.getElementById('results-section'),
            reportMonthYear: document.getElementById('report-month-year'),
            reportTotalHours: document.getElementById('report-total-hours'),
            printButton: document.getElementById('print-button'),
            printDate: document.getElementById('print-date'),
            otSummary: { o10: document.getElementById('summary-ot-10'), o15: document.getElementById('summary-ot-15'), o20: document.getElementById('summary-ot-20'), o30: document.getElementById('summary-ot-30') },
            pay: { monthlySalaryInput: document.getElementById('monthly-salary-input'), baseHoursInput: document.getElementById('base-hours-input'), effectiveRateDisplay: document.getElementById('effective-rate-display'), payout10: document.getElementById('payout-ot-10'), payout15: document.getElementById('payout-ot-15'), payout20: document.getElementById('payout-ot-20'), payout30: document.getElementById('payout-ot-30'), totalPayout: document.getElementById('total-ot-payout') },
            tableBody: document.getElementById('results-table-body'),
            chartCanvas: document.getElementById('report-chart'),
            langThButton: document.getElementById('lang-th-button'),
            langEnButton: document.getElementById('lang-en-button'),
            i18nElements: Array.from(document.querySelectorAll('[data-i18n]'))
          };

          // --- Core Logic ---

          async function analyzePdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;

            // ดึงข้อความจากทุกหน้าใน PDF มารวมกัน
            let fullText = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              fullText += textContent.items.map(item => item.str).join(' ');
            }

            // ตัดข้อความส่วนที่ไม่จำเป็น (ส่วนสรุปท้ายเอกสาร) ทิ้งไป
            const summaryIndex = fullText.lastIndexOf("รวม") > -1 ? fullText.lastIndexOf("รวม") : fullText.lastIndexOf("สรุป");
            const relevantText = summaryIndex > -1 ? fullText.substring(0, summaryIndex) : fullText;
            const normalizedText = relevantText.replace(/\s+/g, ' ');

            // ค้นหารูปแบบวันที่เพื่อระบุเดือนและปีของรายงาน
            const dateMatch = normalizedText.match(/(\d{2})\.(\d{2})\.(\d{4})/);
            if (!dateMatch) throw new Error(i18nDict[appState.lang].errorNoDate);

            const month = parseInt(dateMatch[2]);
            const year = parseInt(dateMatch[3]);
            const daysInMonth = new Date(year, month, 0).getDate();
            const recordsMap = new Map();

            // สร้าง Map สำหรับเก็บข้อมูลของทุกวันในเดือนนั้นๆ
            for (let d = 1; d <= daysInMonth; d++) {
              const dateKey = `${String(d).padStart(2, '0')}.${String(month).padStart(2, '0')}.${year}`;
              const dayOfWeek = new Date(year, month - 1, d).getDay();
              recordsMap.set(dateKey, {
                day: d,
                date: dateKey,
                inOut: '–',
                netHours: 0,
                status: (dayOfWeek === 0 || dayOfWeek === 6) ? 'Weekend' : '–',
                dayOfWeek: dayOfWeek
              });
            }

            // วนลูปอ่านข้อมูลของแต่ละวันจาก Text ที่เตรียมไว้
            normalizedText.split(/(?=\d{2}\.\d{2}\.\d{4})/g).forEach(segment => {
              const segmentDateMatch = segment.match(/^(\d{2}\.\d{2}\.\d{4})/);
              if (segmentDateMatch) {
                const entry = recordsMap.get(segmentDateMatch[0]);
                if (entry) {
                  if (segment.includes('PH')) entry.status = 'Holiday';

                  const timestamps = segment.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/g) || [];
                  if (timestamps.length >= 2) {
                    const timeIn = timestamps[timestamps.length - 2];
                    const timeOut = timestamps[timestamps.length - 1];

                    // Logic คำนวณชั่วโมงทำงานสุทธิ
                    const parseToMinutes = t => (t.split(':').map(Number)[0] * 60) + t.split(':').map(Number)[1];
                    let startMinutes = parseToMinutes(timeIn);
                    let endMinutes = parseToMinutes(timeOut);
                    if (endMinutes < startMinutes) endMinutes += 1440; // กรณีทำงานข้ามวัน

                    let diffMinutes = endMinutes - startMinutes;
                    const netMinutes = diffMinutes > 60 ? diffMinutes - 60 : 0; // หักเวลาพัก 60 นาที

                    // Logic การปัดเศษชั่วโมง: ถ้าเศษเกิน 18 นาที (0.3 ของชั่วโมง) ปัดเป็น 0.5
                    const roundHours = minutes => {
                      if (minutes <= 0) return 0;
                      const hours = minutes / 60;
                      const integerPart = Math.floor(hours);
                      const fractionalPart = hours - integerPart;
                      return fractionalPart > 0.3 ? integerPart + 0.5 : integerPart;
                    };

                    entry.inOut = `${timeIn} - ${timeOut}`;
                    entry.netHours = roundHours(netMinutes);
                  }
                }
              }
            });

            return { results: [...recordsMap.values()], monthIdx: month - 1, year: year };
          }

          // --- UI Rendering Functions ---

          const updateUI_Language = () => {
            DOM.html.lang = appState.lang;
            DOM.i18nElements.forEach(el => {
              el.textContent = i18nDict[appState.lang][el.dataset.i18n] || el.dataset.i18nDefault || '';
            });
            if (appState.data.length) renderAllUI(); // Re-render data with new language

            // Update language button styles
            const setActiveButton = (btn, isActive) => {
              btn.classList.toggle('bg-indigo-600', isActive);
              btn.classList.toggle('text-white', isActive);
              btn.classList.toggle('bg-slate-200', !isActive);
              btn.classList.toggle('text-slate-700', !isActive);
            };
            setActiveButton(DOM.langThButton, appState.lang === 'th');
            setActiveButton(DOM.langEnButton, appState.lang === 'en');
          };

          const renderAllUI = () => {
            DOM.uploaderLoader.classList.toggle('hidden', !appState.busy);
            DOM.uploaderContent.classList.toggle('hidden', appState.busy);

            if (appState.data.length > 0) {
              const locale = appState.lang === 'th' ? 'th-TH' : 'en-US';
              const numberFormat = new Intl.NumberFormat(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              const monthFormat = new Intl.DateTimeFormat(locale, { month: 'long', year: 'numeric' });

              const reportDate = new Date(appState.year, appState.monthIdx);
              DOM.reportMonthYear.textContent = monthFormat.format(reportDate);

              const totalNetHours = appState.data.reduce((sum, d) => sum + d.netHours, 0);
              DOM.reportTotalHours.innerHTML = `${numberFormat.format(totalNetHours)}<span class="text-lg font-medium text-slate-600"> ${i18nDict[appState.lang].tableNetHours.split(' ')[0]}</span>`;

              renderTable();
              renderOtSummary();
              renderChart();
              DOM.resultsSection.classList.remove('hidden');
            } else {
              DOM.resultsSection.classList.add('hidden');
            }
          };

          const renderTable = () => {
            const locale = appState.lang === 'th' ? 'th-TH' : 'en-US';
            const numberFormat = new Intl.NumberFormat(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const shortDayFormat = new Intl.DateTimeFormat(locale, { weekday: 'short' });

            DOM.tableBody.innerHTML = appState.data.map((d, rowIndex) => {
              const otData = appState.otInputs[d.day] || {};
              const otInputsHtml = ['10', '15', '20', '30'].map((rate, colIndex) => `
                        <td class="px-1 sm:px-3 py-1">
                            <input type="number" data-row="${rowIndex}" data-col="${colIndex}" data-day="${d.day}" data-rate="${rate}" 
                                   min="0" max="24" step="0.25" value="${otData[`o${rate}`] || ''}" placeholder="0.00" 
                                   class="ot-input w-20 rounded-md border border-slate-300 p-1.5 text-right outline-none transition-shadow text-sm">
                        </td>`).join('');

              const statusHtml = (() => {
                const lang = appState.lang;
                if (d.status === 'Weekend') return `<span class="inline-flex px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-700">${i18nDict[lang].statusWeekend}</span>`;
                if (d.status === 'Holiday') return `<span class="inline-flex px-2 py-0.5 text-xs rounded-full bg-rose-100 text-rose-700">${i18nDict[lang].statusHoliday}</span>`;
                return `<span class="text-slate-400">–</span>`;
              })();

              return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-3 py-2 whitespace-nowrap">${d.date.substring(0, 5)}<span class="text-slate-500 ml-1.5">(${shortDayFormat.format(new Date(d.date.split('.').reverse().join('-')))})</span></td>
                            <td class="px-3 py-2 whitespace-nowrap">${d.inOut}</td>
                            <td class="px-3 py-2 text-right font-semibold ${d.netHours > 0 ? 'text-slate-800' : 'text-slate-400'}">${numberFormat.format(d.netHours)}</td>
                            ${otInputsHtml}
                            <td class="px-3 py-2 text-center">${statusHtml}</td>
                        </tr>`;
            }).join('');
          };

          const renderOtSummary = () => {
            const totalOT = { o10: 0, o15: 0, o20: 0, o30: 0 };
            Object.values(appState.otInputs).forEach(dayData => {
              Object.keys(totalOT).forEach(key => {
                totalOT[key] += dayData[key] || 0;
              });
            });

            const numberFormat = new Intl.NumberFormat(appState.lang === 'th' ? 'th-TH' : 'en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            Object.keys(totalOT).forEach(key => {
              DOM.otSummary[key].textContent = numberFormat.format(totalOT[key]);
            });
            renderPayCalculation(); // คำนวณค่าแรงใหม่ทุกครั้งที่ OT เปลี่ยน
          };

          const renderPayCalculation = () => {
            const totalOT = { o10: 0, o15: 0, o20: 0, o30: 0 };
            Object.values(appState.otInputs).forEach(dayData => {
              Object.keys(totalOT).forEach(key => totalOT[key] += dayData[key] || 0);
            });

            const effectiveRate = appState.pay.baseHours > 0 ? appState.pay.monthlySalary / appState.pay.baseHours : 0;
            const payouts = {
              p10: totalOT.o10 * 1.0 * effectiveRate,
              p15: totalOT.o15 * 1.5 * effectiveRate,
              p20: totalOT.o20 * 2.0 * effectiveRate,
              p30: totalOT.o30 * 3.0 * effectiveRate,
            };
            const totalPayout = payouts.p10 + payouts.p15 + payouts.p20 + payouts.p30;

            const locale = appState.lang === 'th' ? 'th-TH' : 'en-US';
            const currencyFormat = new Intl.NumberFormat(locale, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            DOM.pay.effectiveRateDisplay.textContent = currencyFormat.format(effectiveRate);
            DOM.pay.payout10.textContent = `฿ ${currencyFormat.format(payouts.p10)}`;
            DOM.pay.payout15.textContent = `฿ ${currencyFormat.format(payouts.p15)}`;
            DOM.pay.payout20.textContent = `฿ ${currencyFormat.format(payouts.p20)}`;
            DOM.pay.payout30.textContent = `฿ ${currencyFormat.format(payouts.p30)}`;
            DOM.pay.totalPayout.textContent = `฿ ${currencyFormat.format(totalPayout)}`;
          };

          const renderChart = () => {
            if (appState.chartInstance) appState.chartInstance.destroy();

            const workingDaysData = appState.data.filter(d => d.netHours > 0);
            const lang = appState.lang;

            const chartData = {
              labels: workingDaysData.map(d => d.day),
              datasets: [{
                label: i18nDict[lang].tableNetHours,
                data: workingDaysData.map(d => d.netHours),
                backgroundColor: 'rgba(79, 70, 229, 0.6)',
                borderColor: 'rgba(79, 70, 229, 1)',
                borderWidth: 1
              }]
            };

            const chartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, title: { display: true, text: i18nDict[lang].tableNetHours.split(' ')[0] } },
                x: { title: { display: true, text: i18nDict[lang].tableDate } }
              }
            };

            appState.chartInstance = new window.Chart(DOM.chartCanvas.getContext('2d'), {
              type: 'bar',
              data: chartData,
              options: chartOptions
            });
          };

          // --- Event Listeners ---

          DOM.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
              DOM.uploaderFilename.textContent = i18nDict[appState.lang].uploaderFilename;
              return;
            }
            DOM.uploaderFilename.textContent = file.name;
            appState.busy = true;
            DOM.resultsSection.classList.add('hidden');
            DOM.errorMessage.classList.add('hidden');
            renderAllUI();

            try {
              const analysisResult = await analyzePdf(file);
              appState.data = analysisResult.results;
              appState.monthIdx = analysisResult.monthIdx;
              appState.year = analysisResult.year;
              appState.otInputs = {}; // Reset OT inputs on new file
            } catch (err) {
              console.error(err);
              appState.data = [];
              DOM.errorMessage.textContent = `${i18nDict[appState.lang].errorPrefix}${err.message}`;
              DOM.errorMessage.classList.remove('hidden');
            } finally {
              appState.busy = false;
              renderAllUI();
            }
          });

          DOM.tableBody.addEventListener('input', (e) => {
            if (e.target.classList.contains('ot-input')) {
              const day = parseInt(e.target.dataset.day);
              const rateKey = `o${e.target.dataset.rate}`;
              let value = parseFloat(e.target.value) || 0;
              value = Math.max(0, Math.min(24, value)); // Clamp value between 0 and 24

              if (!appState.otInputs[day]) appState.otInputs[day] = {};
              appState.otInputs[day][rateKey] = value;

              if (value <= 0) e.target.value = ''; // Clear input if zero

              renderOtSummary();
            }
          });

          DOM.tableBody.addEventListener('blur', (e) => {
            if (e.target.classList.contains('ot-input')) {
              let value = parseFloat(e.target.value);
              if (!isNaN(value) && value > 0) {
                e.target.value = value.toFixed(2);
              } else {
                e.target.value = '';
              }
            }
          }, true);

          DOM.tableBody.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('ot-input')) {
              let { row, col } = e.target.dataset;
              let nextRow = parseInt(row), nextCol = parseInt(col);

              switch (e.key) {
                case 'ArrowUp': nextRow--; e.preventDefault(); break;
                case 'ArrowDown': nextRow++; e.preventDefault(); break;
                case 'ArrowLeft': nextCol--; e.preventDefault(); break;
                case 'ArrowRight': nextCol++; e.preventDefault(); break;
                default: return;
              }

              const nextInput = DOM.tableBody.querySelector(`input[data-row="${nextRow}"][data-col="${nextCol}"]`);
              if (nextInput) {
                nextInput.focus();
                nextInput.select();
              }
            }
          });

          [DOM.pay.monthlySalaryInput, DOM.pay.baseHoursInput].forEach(input => {
            input.addEventListener('input', (e) => {
              const key = e.target.id === 'monthly-salary-input' ? 'monthlySalary' : 'baseHours';
              let value = parseFloat(e.target.value) || 0;
              if (key === 'baseHours') value = Math.max(1, value); // Base hours cannot be zero

              appState.pay[key] = value;
              renderPayCalculation();
            });
          });

          DOM.langThButton.addEventListener('click', () => { appState.lang = 'th'; updateUI_Language(); });
          DOM.langEnButton.addEventListener('click', () => { appState.lang = 'en'; updateUI_Language(); });

          DOM.printButton.addEventListener('click', () => {
            const locale = appState.lang === 'th' ? 'th-TH' : 'en-US';
            DOM.printDate.textContent = `Printed on: ${new Intl.DateTimeFormat(locale, { dateStyle: 'long', timeStyle: 'short' }).format(new Date())}`;
            window.print();
          });

          // --- Initial Run ---
          updateUI_Language();
        };

        // รอจนกว่าไลบรารีภายนอกจะพร้อมใช้งาน แล้วจึงเริ่มการทำงานของแอป
        const readyCheckInterval = setInterval(() => {
          if (window.pdfjsLib && window.Chart) {
            clearInterval(readyCheckInterval);
            initializeApp();
          }
        }, 100);

      })();
  </script>
</body>

</html>